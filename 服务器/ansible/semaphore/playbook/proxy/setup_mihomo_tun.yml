- name: 安装并启用 mihomo（TUN 透明代理）
  hosts: all
  become: 'yes'
  vars:
    mihomo_bundle_dir: '{{ playbook_dir }}/mihomo_bundle'
    mihomo_bin_filename: mihomo
    mihomo_config_filename: config.yaml
    mihomo_bundle_optional_files:
      - Country.mmdb
      - geoip.dat
      - geosite.dat
      - cache.db
    mihomo_install_dir: /opt/mihomo
    mihomo_service_name: mihomo
    mihomo_lock_file: /tmp/ansible-mihomo-tun.lock
    mihomo_config_mode: generated_upstream
    mihomo_upstream_name: UPSTREAM
    mihomo_upstream_type: socks5
    mihomo_upstream_server: ''
    mihomo_upstream_port: 17893
    mihomo_upstream_username: ''
    mihomo_upstream_password: ''
    mihomo_generated_proxy_group_name: PROXY
    mihomo_generated_rules:
      - MATCH,PROXY
    mihomo_generated_mixed_port: 7890
    mihomo_generated_allow_lan: true
    mihomo_generated_mode: rule
    mihomo_generated_log_level: info
    mihomo_generated_external_controller: 127.0.0.1:9090
    mihomo_generated_secret: ''
    mihomo_config_inject_defaults: true
    mihomo_tun_device_name: Mihomo
    mihomo_iproute2_table_index: 8099
    mihomo_iproute2_rule_index: 18099
    mihomo_supported_os_patterns:
      - "(?i)ubuntu.*\\b24(\\.04)?\\b"
      - "(?i)kylin.*\\bv?10\\b.*sp3"
      - "(?i)kylin.*\\bv?10\\b.*(lance|v2207)"
    mihomo_route_exclude_address_default:
      - 127.0.0.0/8
      - 10.0.0.0/8
      - 172.16.0.0/12
      - 192.168.0.0/16
      - 169.254.0.0/16
      - 100.64.0.0/10
      - 224.0.0.0/4
      - 240.0.0.0/4
      - 255.255.255.255/32
    mihomo_route_exclude_address_extra: []
    mihomo_dns_fake_ip_filter_default:
      - +.local
      - +.lan
      - +.home.arpa
      - +.localdomain
      - localhost
  tasks:
    - name: 检查 mihomo 锁文件是否存在
      stat:
        path: '{{ mihomo_lock_file }}'
      register: mihomo_lock
    - name: 如果锁文件存在则终止执行
      fail:
        msg: >-
          已检测到锁文件 {{ mihomo_lock_file }}，说明 mihomo(TUN) 已经被创建过。如需重新配置/卸载，请先执行
          disable_mihomo_tun.yml。
      when: mihomo_lock.stat.exists
    - name: 预处理系统信息
      set_fact:
        mihomo_dist_lower: "{{ ansible_distribution | lower }}"
        mihomo_version_lower: "{{ ansible_distribution_version | lower }}"
        mihomo_release_lower: "{{ ansible_distribution_release | default('') | lower }}"
        mihomo_kernel_lower: "{{ ansible_kernel | default('') | lower }}"
        mihomo_os_fingerprint: >-
          {{ ansible_distribution }} {{ ansible_distribution_version }}
          release={{ ansible_distribution_release | default('') }}
          kernel={{ ansible_kernel | default('') }}
    - name: 校验目标机系统版本（仅支持 Ubuntu 24 LTS / 银河麒麟 V10 SP3 x86_64）
      assert:
        that:
          - ansible_architecture in ["x86_64", "amd64"]
          - ansible_service_mgr == "systemd"
          - >-
            (mihomo_supported_os_patterns
            | select('search', mihomo_os_fingerprint)
            | list | length) > 0
        fail_msg: >-
          当前目标机为 {{ ansible_distribution }} {{ ansible_distribution_version }}
          (release={{ ansible_distribution_release | default('') }}, kernel={{ ansible_kernel | default('') }},
          arch={{ ansible_architecture }}, service_mgr={{ ansible_service_mgr }})，该 playbook 仅支持 Ubuntu 24 LTS 或
          银河麒麟 V10 x86_64（systemd，命中 mihomo_supported_os_patterns 即视为支持）。
    - name: 校验目标机是否支持 TUN（/dev/net/tun）
      stat:
        path: /dev/net/tun
      register: tun_dev
    - name: 如不支持 TUN 则终止执行
      fail:
        msg: 未发现 /dev/net/tun，目标机无法启用 TUN 模式（需内核支持并启用 TUN/TAP）。
      when: not tun_dev.stat.exists
    - name: 校验控制机离线包（mihomo 二进制存在）
      stat:
        path: '{{ mihomo_bundle_dir }}/{{ mihomo_bin_filename }}'
      delegate_to: localhost
      become: 'no'
      register: bundle_mihomo_bin
    - name: 校验控制机离线包（config.yaml 存在，bundle 模式需要）
      stat:
        path: '{{ mihomo_bundle_dir }}/{{ mihomo_config_filename }}'
      delegate_to: localhost
      become: 'no'
      register: bundle_mihomo_cfg
    - name: 如离线包缺失（mihomo 二进制）则终止执行
      fail:
        msg: |
          控制机离线包不完整，请检查目录：
          - {{ mihomo_bundle_dir }}/{{ mihomo_bin_filename }}
      when: not bundle_mihomo_bin.stat.exists
    - name: 如离线包缺失（bundle 模式 config.yaml）则终止执行
      fail:
        msg: |
          bundle 模式需要离线 config.yaml，请检查目录：
          - {{ mihomo_bundle_dir }}/{{ mihomo_config_filename }}
      when:
        - mihomo_config_mode == "bundle"
        - not bundle_mihomo_cfg.stat.exists
    - name: 校验 generated_upstream 模式参数
      assert:
        that:
          - mihomo_upstream_server | length > 0
          - mihomo_upstream_port | int > 0
          - mihomo_upstream_type in ["socks5", "http"]
        fail_msg: >-
          generated_upstream 模式需要配置
          mihomo_upstream_server/mihomo_upstream_port，并且 mihomo_upstream_type
          只能为 socks5 或 http。
      when: mihomo_config_mode == "generated_upstream"
    - name: 创建目标机安装目录
      file:
        path: '{{ mihomo_install_dir }}'
        state: directory
        owner: root
        group: root
        mode: '0755'
    - name: 复制 mihomo 二进制到目标机
      copy:
        src: '{{ mihomo_bundle_dir }}/{{ mihomo_bin_filename }}'
        dest: '{{ mihomo_install_dir }}/mihomo'
        owner: root
        group: root
        mode: '0755'
    - name: 复制可选数据文件（控制机存在则复制）
      stat:
        path: '{{ mihomo_bundle_dir }}/{{ item }}'
      delegate_to: localhost
      become: 'no'
      register: mihomo_optional_bundle_stats
      loop: '{{ mihomo_bundle_optional_files }}'
    - name: 复制可选数据文件到目标机
      copy:
        src: '{{ mihomo_bundle_dir }}/{{ item.item }}'
        dest: '{{ mihomo_install_dir }}/{{ item.item }}'
        owner: root
        group: root
        mode: '0644'
      loop: '{{ mihomo_optional_bundle_stats.results }}'
      when: item.stat.exists
    - name: 读取控制机 config.yaml（用于注入默认配置）
      set_fact:
        mihomo_cfg_raw: '{{ lookup(''file'', mihomo_bundle_dir ~ ''/'' ~ mihomo_config_filename) }}'
      when:
        - mihomo_config_mode == "bundle"
        - mihomo_config_inject_defaults | bool
    - name: 解析控制机 config.yaml 为 YAML（用于注入默认配置）
      set_fact:
        mihomo_cfg_obj: '{{ mihomo_cfg_raw | from_yaml }}'
      when:
        - mihomo_config_mode == "bundle"
        - mihomo_config_inject_defaults | bool
    - name: 生成最小可用配置（generated_upstream 模式） - 第一步：定义基础代理
      set_fact:
        mihomo_upstream_proxy_base:
          name: '{{ mihomo_upstream_name }}'
          type: '{{ mihomo_upstream_type }}'
          server: '{{ mihomo_upstream_server }}'
          port: '{{ mihomo_upstream_port | int }}'
      when: mihomo_config_mode == "generated_upstream"
    - name: 生成最小可用配置（generated_upstream 模式） - 第二步：扩展代理配置
      set_fact:
        mihomo_upstream_proxy: >-
          {{
            mihomo_upstream_proxy_base
            | combine({'udp': true} if mihomo_upstream_type == 'socks5' else {})
            | combine({'username': mihomo_upstream_username} if (mihomo_upstream_username | length > 0) else {})
            | combine({'password': mihomo_upstream_password} if (mihomo_upstream_password | length > 0) else {})
          }}
      when: mihomo_config_mode == "generated_upstream"
    - name: 生成最小可用配置（generated_upstream 模式） - 第三步：生成基础配置对象
      set_fact:
        mihomo_cfg_obj: >-
          {{
            {
              'mixed-port': (mihomo_generated_mixed_port | int),
              'allow-lan': (mihomo_generated_allow_lan | bool),
              'mode': mihomo_generated_mode,
              'log-level': mihomo_generated_log_level,
              'external-controller': mihomo_generated_external_controller,
              'secret': mihomo_generated_secret,
              'proxies': [mihomo_upstream_proxy],
              'proxy-groups': [
                {
                  'name': mihomo_generated_proxy_group_name,
                  'type': 'select',
                  'proxies': [mihomo_upstream_name]
                }
              ],
              'rules': mihomo_generated_rules
            }
          }}
      when: mihomo_config_mode == "generated_upstream"
    - name: 写入目标机 config.yaml（generated_upstream 原始版）
      copy:
        content: '{{ mihomo_cfg_obj | to_nice_yaml(indent=2, sort_keys=false) }}'
        dest: '{{ mihomo_install_dir }}/config.yaml'
        owner: root
        group: root
        mode: '0644'
      when:
        - mihomo_config_mode == "generated_upstream"
        - not (mihomo_config_inject_defaults | bool)
    - name: 生成默认 tun/dns 配置（仅在缺失时补齐）
      set_fact:
        mihomo_cfg_defaults:
          tun:
            enable: true
            device: '{{ mihomo_tun_device_name }}'
            stack: system
            auto-route: true
            strict-route: true
            auto-detect-interface: true
            dns-hijack:
              - any:53
            route-exclude-address: >-
              {{ (mihomo_route_exclude_address_default +
              mihomo_route_exclude_address_extra) | unique }}
          dns:
            enable: true
            enhanced-mode: fake-ip
            fake-ip-filter: '{{ mihomo_dns_fake_ip_filter_default }}'
      when: mihomo_config_inject_defaults | bool
    - name: 合并默认配置（保留用户原配置优先级）
      set_fact:
        mihomo_cfg_merged: '{{ mihomo_cfg_defaults | combine(mihomo_cfg_obj, recursive=True) }}'
      when: mihomo_config_inject_defaults | bool
    - name: 写入目标机 config.yaml（注入默认配置版）
      copy:
        content: '{{ mihomo_cfg_merged | to_nice_yaml(indent=2, sort_keys=false) }}'
        dest: '{{ mihomo_install_dir }}/config.yaml'
        owner: root
        group: root
        mode: '0644'
      when: mihomo_config_inject_defaults | bool
    - name: 写入目标机 config.yaml（原样复制版）
      copy:
        src: '{{ mihomo_bundle_dir }}/{{ mihomo_config_filename }}'
        dest: '{{ mihomo_install_dir }}/config.yaml'
        owner: root
        group: root
        mode: '0644'
      when:
        - mihomo_config_mode == "bundle"
        - not (mihomo_config_inject_defaults | bool)
    - name: 安装 systemd unit
      copy:
        dest: /etc/systemd/system/{{ mihomo_service_name }}.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=mihomo (TUN transparent proxy)
          Wants=network-online.target
          After=network-online.target

          [Service]
          Type=simple
          WorkingDirectory={{ mihomo_install_dir }}
          ExecStart={{ mihomo_install_dir }}/mihomo -d {{ mihomo_install_dir }} -f ./config.yaml
          Restart=on-failure
          RestartSec=2
          LimitNOFILE=1048576

          [Install]
          WantedBy=multi-user.target
    - name: 启用并启动 mihomo 服务
      systemd:
        name: '{{ mihomo_service_name }}'
        enabled: true
        state: restarted
        daemon_reload: true
    - name: 等待 mihomo TUN 网卡出现（可选检查）
      command: ip link show {{ mihomo_tun_device_name }}
      register: mihomo_tun_dev_check
      retries: 10
      delay: 1
      until: mihomo_tun_dev_check.rc == 0
    - name: 创建锁文件（防重复执行）
      copy:
        dest: '{{ mihomo_lock_file }}'
        owner: root
        group: root
        mode: '0644'
        content: |
          mihomo(TUN) installed at {{ ansible_date_time.iso8601 }}
          install_dir={{ mihomo_install_dir }}
          service={{ mihomo_service_name }}
          config_mode={{ mihomo_config_mode }}
          config_inject_defaults={{ mihomo_config_inject_defaults }}
          iproute2_table_index={{ mihomo_iproute2_table_index }}
          iproute2_rule_index={{ mihomo_iproute2_rule_index }}

# “偷渡”指南：如何让一台电脑通过另一台电脑访问受限网络

## 1. 背景故事（我们遇到了什么麻烦？）

想象一下，我们有两台电脑：

- **“网关”电脑 (IP: `192.168.1.100`)**：这是一台“特权”电脑。它可以访问一个神秘的内部网段，我们称之为 **“目标网络 A”** (`10.10.20.0/24`)。
- **“客户端”电脑 (IP: `192.168.1.200`)**：这是一台“平民”电脑。它也想访问 **“目标网络 A”**，但是被安全策略无情地拒绝了，策略规定“只允许 `192.168.1.100` 访问”。

我们的目标是：**让“客户端”电脑能神不知鬼不觉地访问“目标网络 A”**，就好像它自己就是“网关”电脑一样。

我们不希望用 Windows 自带的“端口转发”，因为太麻烦，每开一个新服务都要配一次，不够“透明”。

我们手头还有一张王牌：**WireGuard**。“网关”电脑和“客户端”电脑已经通过 WireGuard 打通了，它们在一个私有的 **“VPN 网络”** (`172.16.0.0/24`) 里，可以互相 ping 通。而且，“网关”电脑上还跑着一个 VMware 虚拟机（Ubuntu），这个 Ubuntu 正好因为用了 VMware 的 NAT 模式，所以也能访问“目标网络 A”。

这给了我们灵感：能不能让“客户端”电脑的流量，先通过 WireGuard 跑到“网关”电脑，然后让“网关”电脑像一个“中介”一样，帮“客户端”电脑去访问“目标网络 A”？

**当然可以！** 这就是我们要做的“网络偷渡”计划。

## 2. 问题诊断：为什么一开始的路由不通？

我们一开始在“客户端”电脑上配了条路由，告诉它：“想去 `10.10.20.0/24`？找 `172.16.0.1`（“网关”电脑的 WireGuard 地址）就对了！”

“客户端”电脑也很听话，把数据包发给了“网关”电脑。但数据包到了“网关”电脑之后，就“傻”了。

- “网关”电脑收到了一个来自“客户端”电脑的包，源地址是 `172.16.0.2`，目标地址是 `10.10.20.10`。
- “网关”电脑知道怎么去 `10.10.20.10`，于是它就帮着把这个包转发过去了。
- **问题来了！** `10.10.20.10` 收到包后，一看源地址是 `172.16.0.2`，它不认识这个地址啊！它想回包也找不到路。
- 更糟的是，安全策略一看，来的不是 `192.168.1.100`，直接就把包扔了。

**一句话总结：“网关”电脑只是个“快递员”，把包原封不动地送了出去，但没帮“客户端”电脑“伪装身份”，结果被目标网络识破了。**

我们需要“网关”电脑做的，不只是转发，而是 **NAT（网络地址转换）**。

> **一个生动的比喻：**
>
> - **没有 NAT**：“客户端”电脑写了封信，寄信地址是自己家（`172.16.0.2`）。“网关”电脑只是帮忙把这封信投递到了 `10.10.20.0/24`。对方一看不认识这个寄信地址，就退信了。
> - **有了 NAT**：“客户端”电脑把信交给“网关”电脑。“网关”电脑拆开信，把原来的寄信地址涂掉，**改成了自己的地址（`192.168.1.100`）**，然后再投递出去。对方收到信，一看是“特权”地址“网关”电脑寄来的，就很开心地回信了。回信寄到“网关”电脑，“网关”电脑再根据记录，把信转交给真正的寄件人“客户端”电脑。

## 3. 解决方案：把“网关”电脑打造成一个“专业中介”

我们要在“网关”电脑上做两件事：

1. **开启“快递”功能**：告诉“网关”电脑的 Windows 系统：“嘿，你要是收到一个不是给你的包，别扔，试着帮它转发一下。”
2. **开启“伪装”功能**：告诉“网关”电脑：“所有从 WireGuard 那边（`172.16.0.0/24`）来的、要去 `10.10.20.0/24` 的包，你都得把它们的源地址改成你自己的物理地址（`192.168.1.100`）再发出去。”

------

### 操作步骤（所有操作都在“网关”电脑上进行！）

#### 第 1 步：开启“快递”功能（启用 IP 路由）

Windows 默认是个“宅男”，只收发自己的信件。我们需要让它变成一个“邮局”。

1. 在“网关”电脑上，**以管理员身份**打开 **注册表编辑器**（按 `Win + R`，输入 `regedit`）。
2. 在地址栏里，复制粘贴这个路径，然后回车： `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters`
3. 在右边空白处，右键点击 -> `新建` -> `DWORD (32 位) 值`。
4. 给这个新值起个名字，必须是：`IPEnableRouter`
5. 双击这个 `IPEnableRouter`，把它的“数值数据”改成 `1`，然后点“确定”。
6. **最关键的一步：重启“网关”电脑！** 不重启，这个设置是不会生效的。

#### 第 2 步：开启“伪装”功能（启用 NAT）

这是最核心的一步。我们用 Windows 自带的 PowerShell 工具来搞定。

##### 可能遇到的坑：`New-NetNat` 报“无效类”

如果你直接运行 `New-NetNat` 命令，很可能会碰到 `New-NetNat : 无效类` 的错误。

别慌，这不是你的错。这是因为 Windows 10/11 默认没把 NAT 功能“装”好。我们需要先把它“请”出来。

##### 解决方案：启用 NAT 驱动服务

1. 在“网关”电脑上，**以管理员身份**打开 **PowerShell**。

2. 复制粘贴下面这条命令，然后回车。它会把和 NAT 相关的底层功能给启用。

   ```powershell
   dism.exe /Online /Enable-Feature /FeatureName:Microsoft-Hyper-V-Tools-All /All
   ```

   > **小知识**：虽然命令里有 `Hyper-V`，但它顺带会把我们需要的 `WinNAT` 服务一起装上，这是最简单可靠的方法。

3. 命令跑完后，**系统可能会让你重启电脑，请照做**。

##### 创建 NAT 规则

重启后，`New-NetNat` 命令就能正常工作了。

1. 再次**以管理员身份**打开 **PowerShell**。

2. 输入下面这条“魔法”命令，然后回车：

   ```powershell
   New-NetNat -Name "WireGuardToTargetNAT" -InternalIPInterfaceAddressPrefix "172.16.0.0/24"
   ```

   - 命令解释
     - `New-NetNat`：创建一个新的 NAT 规则。
     - `-Name "..."`：给规则起个名，随便起，好记就行。
     - `-InternalIPInterfaceAddressPrefix "172.16.0.0/24"`：**核心中的核心！** 这句话告诉“网关”电脑：“所有来自 `172.16.0.0` 这个内部网络的流量，要出去的时候，都给我伪装一下！”

3. 如果命令执行后没任何提示，那就说明**成功了**！你可以用下面这条命令来检查一下：

   ```powershell
   Get-NetNat
   ```

   你应该能看到你刚刚创建的规则：

   ```powershell
   Name                   : WireGuardToTargetNAT
   
   ExternalIPInterfaceAddressPrefix :
   
   InternalIPInterfaceAddressPrefix : 172.16.0.0/24
   
   ...
   ```

**至此，“网关”电脑这个“专业中介”已经打造完毕！**

------

## 4. 验证与测试

激动人心的时刻到了！现在去“客户端”电脑上验证一下。

1. 在“客户端”电脑上，打开 **命令提示符 (CMD)**。

2. 我们用 `tracert`（路径追踪）这个神器来看看数据包到底是怎么走的。输入：

   ```powershell
   tracert 10.10.20.1
   ```

   （把 `10.10.20.1` 换成“目标网络 A”里一个真实存在的 IP）

3. **成功的标志**：你应该会看到类似下面的结果：

   ```powershell
   Tracing route to 10.10.20.1 over a maximum of 30 hops
   
   
   
     1   <1 ms    <1 ms    <1 ms  172.16.0.1      <-- 第一跳：客户端 -> 网关 (通过WireGuard隧道)
   
     2   2 ms     1 ms     1 ms  192.168.1.100   <-- 第二跳：网关！NAT伪装成功！包从网关的物理网卡出去了！
   
     3   3 ms     2 ms     2 ms  10.10.20.1      <-- 成功到达目标！
   
     ...
   ```

   **看到第二跳是 `192.168.1.100`，就说明你的“偷渡”计划大功告成！** “客户端”电脑的流量已经被完美地伪装成了“网关”电脑的流量。

4. 最后，试试 `ping` 和访问具体服务：

   ```powershell
   ping 10.10.20.1
   ```

   现在应该可以通了！你可以尝试在浏览器里访问“目标网络 A”的网页，或者用 RDP 连接，都应该像在“网关”电脑上一样顺畅。

## 5. 如果还是不行？终极排查

如果 `tracert` 的第二跳还是看不到“网关”电脑的物理 IP，那 99% 的问题出在 **防火墙** 上。

**临时关掉防火墙测试一下（仅在“网关”电脑上操作）：**

1. 在“网关”电脑上，**以管理员身份**打开 **PowerShell**。

2. 输入下面命令，暂时关闭所有防火墙：

   ```powershell
   Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
   ```

3. **立刻回到“客户端”电脑上，再运行一次 `tracert` 和 `ping`。**

- **如果现在成功了**：恭喜，问题确定是防火墙！记得把防火墙重新打开（把上面的 `False` 改成 `True` 再运行一遍），然后去防火墙设置里，添加一条允许 `172.16.0.0/24` 网段流量的规则。

- 如果还是失败

  ：那就有点奇怪了。请仔细检查：

  1. “网关”电脑的 `IPEnableRouter` 注册表值是不是 `1`，并且重启了？
  2. “网关”电脑的 `WinNAT` 服务是不是正在运行？（在“服务”里查看）
  3. WireGuard 隧道本身是不是正常的？（在“客户端”电脑上 `ping 172.16.0.1` 是否通？）

好了，这份通用版的“偷渡”指南就到这里。祝你网络畅通！